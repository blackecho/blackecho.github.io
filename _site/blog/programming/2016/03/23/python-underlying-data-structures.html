<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Understanding Python's underlying data structures</title>
  <meta name="description" content="Let’s take a look at how Python’s typical data structures (lists, tuples, dicts, sets) are implemented, and how we can take advantage of this knowledge to op...">

  <link rel="canonical" href="http://blackecho.github.io/blog/programming/2016/03/23/python-underlying-data-structures.html">
  <link rel="alternate" type="application/rss+xml" title="Gabriele Angeletti" href="http://blackecho.github.io/feed.xml" />

  <!-- Material Design Lite css Library -->
  <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/code.getmdl.io/1.1.1/material.light_green-indigo.min.css">

  <!-- Material Design Fonts -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- Custom theme css -->
  <link rel="stylesheet" href="/css/main.css">
</head>


  <body>

    <!-- Start Layout -->
    
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <!-- search layout -->
<div class="super-search" id="js-search">
  <ul class="super-search__results" id="js-search__results"></ul>        
  <button class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored super-search__close-btn" onclick="superSearch.toggle()">
    <i class="material-icons">close</i>
  </button>
</div>
<!-- /end search -->
        <header class="mdl-layout__header">

    <div class="mdl-layout__header-row">
      <!-- Title -->
      <a href="http://blackecho.github.io"><span class="mdl-layout-title">Gabriele Angeletti</span></a>
      <!-- Add spacer, to align navigation to the right -->
      <div class="mdl-layout-spacer"></div>


      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable is-upgraded">
        <label class="mdl-button mdl-js-button mdl-button--icon" for="js-search__input">
          <i class="material-icons">search</i>
        </label>

        <div class="mdl-textfield__expandable-holder" >
          <input class="mdl-textfield__input super-search__input" type="text" id="js-search__input" />
        </div>
      </div>

      <button class="mdl-button mdl-js-button mdl-button--icon" id="menu-lower-left">
        <i class="material-icons">more_vert</i>
      </button>

      <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="menu-lower-left">
        
        <li><a href="https://medium.com/@gabrieleang" class="mdl-menu__item">Medium</a></li>
        
        <li><a href="https://www.quora.com/profile/Gabriele-Angeletti" class="mdl-menu__item">Quora</a></li>
        
        <li><a href="https://www.linkedin.com/in/gabriele-angeletti-71959a63" class="mdl-menu__item">LinkedIn</a></li>
        
      </ul>
    </div>
  </header>

  <div class="mdl-layout__drawer">
    <span class="mdl-layout-title">Menu</span>
    <nav class="mdl-navigation">
    
      
      <a class="mdl-navigation__link" href="/about-blog/">About this Blog</a>
      
    
      
      <a class="mdl-navigation__link" href="/about-me/">About Me</a>
      
    
      
    
      
    
      
    
      
      <a class="mdl-navigation__link" href="/projects/">Projects</a>
      
    
    </nav>

  </div>

    

    <div class="post-ribbon"></div>
<main class="post-main mdl-layout__content">
  <div class="post-container mdl-grid">
    <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
    <div class="post-section mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col">
      <div class="mdl-color-text--grey-500">
      Mar 23, 2016 • Gabriele Angeletti •  blog  programming  
      </div>
      <h3 class="">Understanding Python's underlying data structures</h3>
      <article class="post-content">
        <p class="post-paragraph"><p>Let’s take a look at how Python’s typical data structures (lists, tuples, dicts, sets) are implemented, and how we can take advantage of this knowledge to optimize our code. The implementation we are focusing on is CPython.</p>

<p>CPython is the <a href="http://stackoverflow.com/questions/17130975/python-vs-cpython">original implementation</a> of Python, written in C. Since Python is a high-level language, the code you execute has to be evaluated and interpreted somehow. CPython is the program that translates Python instructions, written following the language specification, to something the machine can actually execute. Specifically, it compiles the code into bytecode, which then get interpreted and executed.
There are other implementations of Python “the language”, like <a href="http://www.jython.org/">Jython</a> written in Java and <a href="http://ironpython.net/">Iron Python</a> written in C#.
The high-level Python code you wrote is the same (a list of integers is <code class="highlighter-rouge">l = [1, 2, 3]</code> in all of them), it is the underlying implementation that changes: for example CPython creates a C array, while Jython creates a Java ArrayList.</p>

<p>Knowing how the language data structures are actually implemented can give you a deeper understanding of what’s going on, and can allow you to optimize your code.
Now we’ll see the implementation of lists, tuples, dictionaries and sets.</p>

<h3 id="lists">Lists</h3>
<p>Python’s lists are implemented as variable-length arrays of <code class="highlighter-rouge">PyObject</code>s. The name is a bit confusing because it resembles Linked Lists, but they are actually arrays.</p>

<p>The implementation uses a contiguous array of references to other objects, and keeps a pointer to this array and the array’s length in a list head structure.
This makes indexing a list an operation whose cost is independent of the size of the list or the value of the index.
When items are appended or inserted, the array of references is resized. Some cleverness is applied to improve the performance of appending items repeatedly; when the array must be grown, some extra space is allocated so the next few times don’t require an actual resize (otherwise, every append/insert would require a resize of the array resulting in very poor performances).
You can see this over-allocation at line 42 of the <a href="https://hg.python.org/cpython/file/tip/Objects/listobject.c">CPython source code</a> of the list object. The over-allocation is enough to give linear time behavior over a long list of appends. The growth pattern is: 0, 4, 8, 16, 25, 46, 58, 72, 88, …
Thus, if you perform a million consecutive appends, the resizing mechanism accounts for this and doesn’t resize a lot of times.</p>

<p>Python lists are optimized for fast fixed-length operations and incur O(n) memory movement costs for <code class="highlighter-rouge">pop(0)</code> and <code class="highlighter-rouge">insert(0, v)</code> operations which change both the size and, more important, the position of the underlying data representation.</p>

<p>The following two little experiments show some optimizations we can do:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def f(n):
    l = []
    for i in range(n):
        l.append(i)
    return l

def g(n):
    l = []
    for i in range(n):
        l.insert(i, i)
    return l
</code></pre></div></div>

<p>The two functions has the same effect, they return a list of natural numbers from 0 to n. The function f is slightly faster, as you can see from this plot (the execution time was measured using the handy ipython module <code class="highlighter-rouge">%timeit</code>):</p>

<p><img src="../../../../../img/functionsfg.png" alt="plot of python functions execution time" /></p>

<p>The following experiment shows the (huge) O(n) cost for resizing of the <code class="highlighter-rouge">insert(0, v)</code> operation. If we modify the functions above to return the list of natural numbers in inverted order, we can see that it is much (very much) faster to append the elements and then <code class="highlighter-rouge">reverse()</code> the resulting list rather than doing <code class="highlighter-rouge">insert(0, v)</code> operations.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def f(n):
    l = []
    for i in range(n):
        l.append(i)
    l.reverse()
    return l

def g(n):
    l = []
    for i in range(n):
        l.insert(0, i)
    return l
</code></pre></div></div>

<p>The difference between the two is so big that instead of plotting the results I’ll show you the numbers (unit is the microsecond):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input:      [100,  1000, 1000, 50000, 100000, 200000]
function f: [9.43, 89.1, 849, 4430, 9300, 18900]
function g: [24.3, 463, 29300, 785000, 3240000, 13000000]
</code></pre></div></div>

<h3 id="tuples">Tuples</h3>
<p>The main difference between lists and tuples is that tuples are immutable objects: that is once they are created, they cannot be modified anymore (of course the tuple cannot be modified, but the variable pointing to it can).
Because of this immutability property, tuples are useful for representing what other languages often call records — some related information that belongs together, like a person’s information. A tuple lets us “chunk” together related information and use it as a single thing.</p>

<p>Python’s tuple implementation is basically the same as list but with optimizations that exploit the particular features of tuples, like fixed size. A very clever (in my opinion) optimization is one that is employed with allocation of small tuples.
Taken from <a href="http://stackoverflow.com/questions/14135542/how-is-tuple-implemented-in-cpython">here</a>:</p>
<blockquote>
To avoid allocating a bunch of small objects, CPython recycles memory for many small tuples. There is a fixed constant (PyTuple_MAXSAVESIZE) such that all tuples less than this length are eligible to have their space reclaimed. Whenever an object of length less than this constant is deallocated, there is a chance that the memory associated with it will not be freed and instead will be stored in a "free list" (more on that in the next paragraph) based on its size. That way, if you ever need to allocate a tuple of size n and one has previously been allocated and is no longer in use, CPython can just recycle the old array.
</blockquote>

<h3 id="dictionaries">Dictionaries</h3>
<p>Python dictionaries are implemented using hash tables. A hash table is an array whose indexes are obtained using a hash function on the keys. The key can be a number, a string or an object, the important thing is that it must be an immutable object (i.e. we can define a hash function on it). The hash function is a function <code class="highlighter-rouge">h : K -&gt; N</code> which takes in input a key <code class="highlighter-rouge">k</code> and return an integer <code class="highlighter-rouge">h(k)</code> representing the array index of the value corresponding to the key.
The goal of a hash function is to distribute the keys evenly in the array. A good hash function minimizes the number of collisions e.g. different keys having the same hash.</p>

<p>When there is a collision, it must be resolved. A naive approach would be to have linked lists of values instead of values in the values array, but then the lookup operation would not be O(1) anymore. Instead, Python uses a quadratic probing sequence to find a free slot in the case of collisions.</p>

<p>So every time you want to verify if a dictionary contains a key, what the interpreter does is to hash the value of the key to obtain the index and then verify if array[index] is empty. We would want to minimize the number of such operations.</p>

<p>For example, a common use case of dictionaries is counting object, like word frequencies. In these cases, items are initialized once and modified many times. To implement this function we could write something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def f(words):
    wdict = {}
    for word in words:
        if word not in wdict:
            wdict[word] = 0
        wdict[word] += 1
    return wdict
</code></pre></div></div>

<p>The problem with the above code is that except for the first time a new word is seen, the if test will fail every time, wasting a lot of hash function computations. We can avoid this with the following code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def g(words):
    wdict = {}
    for word in words:
        try:
            wdict[word] += 1
        except KeyError:
            wdict[word] = 1
</code></pre></div></div>

<p>Note: it is important to use KeyError in the except clause. You want the dictionary to be modified only when this exception occurs.</p>

<p>If the list is small the two functions are absolutely interchangeable. When the list get reasonably large, the second approach gets usually faster. For example, with the list I tried I got <code class="highlighter-rouge">3.08s</code> execution time with the first approach and <code class="highlighter-rouge">2.66s</code> with the second one.</p>

<h3 id="sets">Sets</h3>
<p>The implementation of Python sets derive from the dictionary implementation. Indeed, there is some <a href="http://markmail.org/message/ktzomp4uwrmnzao6">evidence</a> that originally the implementation was mostly a copy-paste from the dict implementation.</p>

<p>Python sets are implemented as dictionaries with dummy values (i.e. the keys are the members of the set) and there are optimizations for cache locality which take advantage of this lack of values. Thus, sets membership is done in O(1) as in dictionaries. Note that in the worst case (i.e. all hash collisions) the membership-checking is O(n).</p>

<p>Because of this amazingly fast membership checking, sets are the obvious choice when you have a list of values and you don’t care about the order of the items, but just whether an item belongs to the list or not. Of course this is true only if the set is already there. If you include the set creation time, then a list is usually faster, as the following experiment shows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def f(e):
    l = range(1000000)
    return e in l

def g(e):
    s = set(range(1000000))
    return e in l
</code></pre></div></div>

<p><code class="highlighter-rouge">f(645000)</code> took <code class="highlighter-rouge">30.7ms</code> while <code class="highlighter-rouge">g(645000)</code> took <code class="highlighter-rouge">142ms</code>. But if we measure only the membership-checking time, then things are different: the list took <code class="highlighter-rouge">13.9ms</code> while the set only <code class="highlighter-rouge">65.4ns</code>! So keep in mind that in order to take advantage of the set data structure you have to be in a situation when you create the set once and read it many times.</p>

<p>That’s it for now. I hope you enjoyed the article. Please write a comment if you have any feedback.</p>

<p>PS: for further reference, there’s no better place than the CPython source code: <a href="https://hg.python.org/cpython/file/tip/Objects/listobject.c">listobject source code</a>, <a href="https://hg.python.org/cpython/file/tip/Objects/dictobject.c">dictobject</a>, <a href="https://hg.python.org/cpython/file/tip/Objects/tupleobject.c">tupleobject</a>, <a href="https://hg.python.org/cpython/file/tip/Objects/setobject.c">setobject</a>.</p>

</p>
      </article>
      <!-- Disqus comments -->
      
      <div>
        <h3>Comments</h3>
        <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'gabrieleangeletti';
        var disqus_developer = 0; // developer mode is on
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

      </div>
      
    </div>
  </div>
</main>

    <footer class="mdl-mega-footer">
    <div class="mdl-mega-footer--middle-section">

        <div class="mdl-mega-footer--drop-down-section">
            <input class="mdl-mega-footer--heading-checkbox" type="checkbox" checked>
            <h1 class="mdl-mega-footer--heading">INFO</h1>
            <ul class="mdl-mega-footer--link-list">
                <li><a href="mailto:angeletti.gabriele@gmail.com">angeletti.gabriele@gmail.com</a></li>
                <li><a href=" /feed.xml ">subscribe via RSS</a></li>
            </ul>
        </div>

        <div class="mdl-mega-footer--drop-down-section">
            <input class="mdl-mega-footer--heading-checkbox" type="checkbox" checked>
            <h1 class="mdl-mega-footer--heading">SOCIAL</h1>
            <ul class="mdl-mega-footer--link-list">
                
                    <li>
                        <a href="https://github.com/blackecho">
                            <span class="icon  icon--github">
                                <svg viewBox="0 0 16 16">
                                    <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                                </svg>
                            </span>
                            <span class="username">blackecho</span>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://twitter.com/gabrieleang">
                            <span class="icon  icon--twitter">
                                <svg viewBox="0 0 16 16">
                                    <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                                        c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                                </svg>
                            </span>
                            <span class="username">gabrieleang</span>
                        </a>
                    </li>
                
                
                
                
                    <li>
                        <a href="https://plus.google.com/u/0/+GabrieleAngeletti">
                            <span class="icon  icon--googleplus_per">
                                <svg style="width:16px;height:16px" viewBox="0 0 24 24">
				                    <path fill="#000000" d="M20,2A2,2 0 0,1 22,4V20A2,2 0 0,1 20,22H4A2,2 0 0,1 2,20V4C2,2.89 2.9,2 4,2H20M20,12H18V10H17V12H15V13H17V15H18V13H20V12M9,11.29V13H11.86C11.71,13.71 11,15.14 9,15.14C7.29,15.14 5.93,13.71 5.93,12C5.93,10.29 7.29,8.86 9,8.86C10,8.86 10.64,9.29 11,9.64L12.36,8.36C11.5,7.5 10.36,7 9,7C6.21,7 4,9.21 4,12C4,14.79 6.21,17 9,17C11.86,17 13.79,15 13.79,12.14C13.79,11.79 13.79,11.57 13.71,11.29H9Z" />
			                    </svg>
                            </span>
                            <span class="username">Google Plus</span>
                        </a>
                    </li>
                
            </ul>
        </div>

        <div class="mdl-mega-footer--drop-down-section">
            <input class="mdl-mega-footer--heading-checkbox" type="checkbox" checked>
            <h1 class="mdl-mega-footer--heading">ABOUT</h1>
            <ul class="mdl-mega-footer--link-list">
                <li>My blog about Artificial Intelligence, Machine Learning and related topics.
</li>
            </ul>
        </div>

    </div>

    <div class="mdl-mega-footer--bottom-section">
        <div class="mdl-logo">Gabriele Angeletti</div>
        <ul class="mdl-mega-footer--link-list">
            <li><a href="mailto:angeletti.gabriele@gmail.com">Contact</a></li>
        </ul>
    </div>

</footer>

<!-- JavaScript imports at the end of the body -->

<!-- JQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<!-- Mathjax configuration with single dollar sign delimiters -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<!-- MathJax -->
<script type="text/javascript" src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!-- Cookie -->
<script>
    document.cookie = "analytics-filter-spam=myblog2016; expires=Sun, 18 Dec 2016 12:00:00 UTC";
</script>

<!-- Google Analytics -->
<script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-41410147-2', 'auto');
    ga('send', 'pageview');

    // custom dimentsion analytics-filter-spam
    var dimensionValue = '';
    ga('set', 'dimension1', dimensionValue);
</script>

    </div>
    <!-- /End Layout -->

    <!-- Material Design Lite js Library -->
    <script type="text/javascript" src="https://storage.googleapis.com/code.getmdl.io/1.1.1/material.min.js"></script>
    
    <script rel="javascript" type="text/javascript" src="/js/site.js"></script>
    
    <script rel="javascript" type="text/javascript" src="/js/search.js"></script>
    <script rel="javascript" type="text/javascript">
      superSearch({
        searchFile: '/feed.xml',
        searchSelector: '#js-search', // CSS Selector for search container element.
        inputSelector: '#js-search__input', // CSS selector for <input>
        resultsSelector: '#js-search__results' // CSS selector for results container
      });
    </script>
  </body>

</html>
